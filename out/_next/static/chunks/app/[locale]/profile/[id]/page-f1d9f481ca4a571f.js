(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[569],{6832:function(e,t,a){Promise.resolve().then(a.bind(a,7817))},7817:function(e,t,a){"use strict";a.d(t,{default:function(){return Z}});var l=a(7437),i=a(9376),s=a(8016),n=a(2265),r=a(1837);function o(e){let{profile:t,onProfileUpdate:a,onBack:i}=e,[s,o]=(0,n.useState)(null),[d,c]=(0,n.useState)(""),[u,m]=(0,n.useState)(!1),h=(0,n.useRef)(null);(0,n.useEffect)(()=>{s&&h.current&&(h.current.focus(),h.current.select())},[s]);let v=(e,t)=>{o(e),c(t)},x=async()=>{if(!s||u)return;let e=d.trim(),l={};if("name"===s&&e!==t.name){if(!e){o(null);return}l.name=e}else"place_of_birth"===s&&e!==(t.place_of_birth||"")&&(l.place_of_birth=e||void 0);if(0===Object.keys(l).length){o(null);return}try{m(!0);let e=await (0,r.ck)(t.id,l);a(e)}catch(e){console.error("Failed to save:",e)}finally{m(!1),o(null)}},p=e=>{"Enter"===e.key?x():"Escape"===e.key&&o(null)};return(0,l.jsxs)("div",{className:"tui-bg-panel border-b tui-border-color px-4 py-4 mb-4",children:[(0,l.jsxs)("div",{className:"flex items-center gap-3 mb-2",children:[i&&(0,l.jsx)("button",{onClick:i,className:"tui-text-muted p-1 -ml-1",title:"Back to profiles",children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,l.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),"name"===s?(0,l.jsx)("input",{ref:h,type:"text",value:d,onChange:e=>c(e.target.value),onBlur:x,onKeyDown:p,className:"text-2xl font-bold tui-text bg-transparent border-b-2 outline-none w-full",style:{borderColor:"var(--tui-water)"},maxLength:100}):(0,l.jsx)("h1",{onClick:()=>v("name",t.name),className:"text-2xl font-bold tui-text cursor-pointer px-1 -mx-1",title:"Click to edit",children:t.name})]}),(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-sm tui-text-dim mb-2",children:[(0,l.jsx)("span",{children:(()=>{let e=[t.birth_date];return t.birth_time&&e.push(t.birth_time),e.join(" ")})()}),(0,l.jsx)("span",{className:"tui-text-muted",children:"|"}),(0,l.jsx)("span",{style:{color:"female"===t.gender?"var(--tui-accent-pink)":"var(--tui-water)"},children:"female"===t.gender?"♀ Female":"♂ Male"})]}),(0,l.jsxs)("div",{className:"flex items-center text-sm",children:[(0,l.jsx)("span",{className:"tui-text-muted mr-2",children:"Place of birth:"}),"place_of_birth"===s?(0,l.jsx)("input",{ref:h,type:"text",value:d,onChange:e=>c(e.target.value),onBlur:x,onKeyDown:p,placeholder:"Enter place of birth...",className:"tui-text-dim bg-transparent border-b outline-none flex-1",style:{borderColor:"var(--tui-water)"},maxLength:200}):(0,l.jsx)("span",{onClick:()=>v("place_of_birth",t.place_of_birth||""),className:"cursor-pointer px-1 -mx-1 ".concat(t.place_of_birth?"tui-text-dim":"tui-text-muted italic"),title:"Click to edit",children:t.place_of_birth||"Click to add..."})]}),u&&(0,l.jsx)("div",{className:"absolute top-2 right-2 text-xs tui-text-muted",children:"Saving..."})]})}var d=a(8706),c=a(9234);let u={Wood:"tui-text-wood",Fire:"tui-text-fire",Earth:"tui-text-earth",Metal:"tui-text-metal",Water:"tui-text-water"},m={Jia:"Wood",Yi:"Wood",Bing:"Fire",Ding:"Fire",Wu:"Earth",Ji:"Earth",Geng:"Metal",Xin:"Metal",Ren:"Water",Gui:"Water"};function h(e){return e.replace("Yang ","").replace("Yin ","")}function v(e){var t,a,i,s,n;let{pillar:r,type:o,index:d,mappings:c,isLuck:v,isEmpty:x}=e,p=()=>{let e={borderWidth:"1px",borderStyle:"solid",borderColor:"var(--tui-border)"};return x?{...e,borderStyle:"dashed",background:"transparent"}:e};if(x)return(0,l.jsx)("div",{className:"w-28 flex-shrink-0",children:(0,l.jsx)("div",{className:"tui-cell flex items-center justify-center",style:{...p(),height:"stem"===o?"4rem":"5rem"},children:(0,l.jsx)("span",{className:"tui-text-muted",children:r.label||"---"})})});if("stem"===o){let e=u[h((null===(s=r.stem)||void 0===s?void 0:s.element)||"Unknown")]||"tui-text";return(0,l.jsx)("div",{className:"w-28 flex-shrink-0",children:(0,l.jsx)("div",{className:"tui-cell p-1",style:{...p(),height:"4rem"},children:(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center h-full",children:[(0,l.jsx)("span",{className:"text-lg ".concat(r.isUnknown?"tui-text-muted":e),children:(null===(n=r.stem)||void 0===n?void 0:n.chinese)||"?"}),(0,l.jsx)("span",{className:"tui-text-dim",children:r.isUnknown?"?":1!==d||v?r.tenGod||"":"DM"})]})})})}let b=u[h((null===(t=r.branch)||void 0===t?void 0:t.element)||"Unknown")]||"tui-text";return Object.values(r.hiddenQi||{}).reduce((e,t)=>e+t,0),(0,l.jsx)("div",{className:"w-28 flex-shrink-0",children:(0,l.jsxs)("div",{className:"tui-cell relative",style:{...p(),height:"5rem"},children:[(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center pt-2 pb-5",children:[(0,l.jsx)("span",{className:"text-lg ".concat(r.isUnknown?"tui-text-muted":b),children:(null===(a=r.branch)||void 0===a?void 0:a.chinese)||"?"}),!r.isUnknown&&(null===(i=r.branch)||void 0===i?void 0:i.animal)&&!["Fire","Water","Metal","Wood","Earth"].includes(r.branch.animal)&&(0,l.jsx)("span",{className:"tui-text-dim",children:r.branch.animal})]}),r.hiddenQi&&Object.keys(r.hiddenQi).length>0&&(0,l.jsx)("div",{className:"absolute bottom-0 left-0 right-0 flex overflow-hidden",style:{height:"1.25rem",borderTop:"1px solid var(--tui-border)"},children:Object.entries(r.hiddenQi).map((e,t)=>{var a,i;let[s,n]=e,o=(null==c?void 0:null===(a=c.heavenly_stems)||void 0===a?void 0:a[s])||{},d=(null===(i=r.hiddenStems)||void 0===i?void 0:i[s])||"",v=Object.keys(r.hiddenQi).length,x=u[m[s]||h(o.element||"Unknown")]||"tui-text";return(0,l.jsxs)("div",{className:"flex items-center justify-center overflow-hidden",style:{flex:0===t?"2":1===t?"1.5":"1",borderRight:t<v-1?"1px solid var(--tui-border)":"none",minWidth:0},title:"".concat(o.chinese||s," ").concat(d),children:[(0,l.jsx)("span",{className:"text-xs ".concat(x),children:o.chinese||s.charAt(0)}),(0,l.jsx)("span",{className:"text-xs tui-text-muted",children:d})]},s)})})]})})}let x={Zi:"Water",Chou:"Earth",Yin:"Wood",Mao:"Wood",Chen:"Earth",Si:"Fire",Wu:"Fire",Wei:"Earth",Shen:"Metal",You:"Metal",Xu:"Earth",Hai:"Water"},p={Jia:{element:"Wood",polarity:"yang"},Yi:{element:"Wood",polarity:"yin"},Bing:{element:"Fire",polarity:"yang"},Ding:{element:"Fire",polarity:"yin"},Wu:{element:"Earth",polarity:"yang"},Ji:{element:"Earth",polarity:"yin"},Geng:{element:"Metal",polarity:"yang"},Xin:{element:"Metal",polarity:"yin"},Ren:{element:"Water",polarity:"yang"},Gui:{element:"Water",polarity:"yin"}},b={Wood:"木",Fire:"火",Earth:"土",Metal:"金",Water:"水"};function y(e){var t,a,i;let{chartData:s,showNatal:r=!0,show10YrLuck:o=!1,showLuck:c=!0,showTalisman:u=!0,showLocation:m=!0}=e,h=(0,d.T)("forms"),y=(null==s?void 0:s.mappings)||{},g=(null==s?void 0:null===(t=s.hs_d)||void 0===t?void 0:t.id)||"Yi",[f,_]=(0,n.useState)(null),j=function(e,t,a){var l,i,n,r,o,d,c,u;let m,h=arguments.length>3&&void 0!==arguments[3]&&arguments[3],v=null==s?void 0:s[e],f=null==s?void 0:s[t];if(!v&&!f)return null;let _=null==v?void 0:v.id,j=null==f?void 0:f.id,N=(null===(l=y.heavenly_stems)||void 0===l?void 0:l[_])||{},w=p[_],k=(null==w?void 0:w.element)||"Unknown",C={chinese:N.chinese||_||"?",element:k,color:N.hex_color};if(["Fire","Water","Metal","Wood","Earth"].includes(j))m={chinese:b[j]||j,animal:j,element:j,color:null===(n=y.elements)||void 0===n?void 0:null===(i=n[j])||void 0===i?void 0:i.hex_color};else{let e=(null===(r=y.earthly_branches)||void 0===r?void 0:r[j])||{},t=x[j]||"Unknown";m={chinese:e.chinese||j||"?",animal:e.animal||"?",element:t,color:e.hex_color}}let W=(null==f?void 0:f.post_interaction_qi)&&Object.keys(f.post_interaction_qi).length>0?f.post_interaction_qi:null,D=(null==f?void 0:f.base_qi)&&Object.keys(f.base_qi).length>0?f.base_qi:null,S=W||D||{},E={};if(S&&y.ten_gods)for(let e of Object.keys(S)){let t=null===(d=y.ten_gods)||void 0===d?void 0:null===(o=d[g])||void 0===o?void 0:o[e];E[e]=(null==t?void 0:t.abbreviation)||(null==t?void 0:t.id)||""}let M=null;if(h)M="DM";else if(_&&y.ten_gods){let e=null===(u=y.ten_gods)||void 0===u?void 0:null===(c=u[g])||void 0===c?void 0:c[_];M=(null==e?void 0:e.abbreviation)||(null==e?void 0:e.id)||null}let L=(null==v?void 0:v.badges)||[],F=(null==f?void 0:f.badges)||[];return{label:a,stem:C,stemName:_,branch:m,branchName:j,stemKey:e,branchKey:t,hiddenStems:E,hiddenQi:S,tenGod:M,isDayMaster:h,isUnknown:!v&&!f,qiPhase:(null==v?void 0:v.qi_phase)||(null==f?void 0:f.qi_phase)||null,stemTransformations:L.filter(e=>"transformation"===e.type),branchTransformations:F.filter(e=>"transformation"===e.type),stemCombinations:L.filter(e=>"combination"===e.type),branchCombinations:F.filter(e=>"combination"===e.type),stemNegatives:L.filter(e=>["clash","harm","punishment","destruction","stem_conflict"].includes(e.type)),branchNegatives:F.filter(e=>["clash","harm","punishment","destruction","stem_conflict"].includes(e.type)),branchWealthStorage:F.filter(e=>"wealth_storage"===e.type)}},N=(0,n.useMemo)(()=>{let e=j("hs_h","eb_h",h("natal.pillar_labels.hour"))||{label:h("natal.pillar_labels.hour"),stem:{chinese:"?",element:"Unknown",color:"#808080"},stemName:"?",branch:{chinese:"?",animal:"?",element:"Unknown",color:"#808080"},branchName:"?",hiddenStems:{},hiddenQi:{},tenGod:null,isDayMaster:!1,isUnknown:!0,stemTransformations:[],branchTransformations:[],stemCombinations:[],branchCombinations:[],stemNegatives:[],branchNegatives:[],branchWealthStorage:[]};return[e,j("hs_d","eb_d",h("natal.pillar_labels.day"),!0),j("hs_m","eb_m",h("natal.pillar_labels.month")),j("hs_y","eb_y",h("natal.pillar_labels.year"))].filter(Boolean)},[s,h]),w=e=>({label:e,stem:{chinese:"",element:"Unknown",color:"#f3f4f6"},stemName:"",branch:{chinese:"",animal:"",element:"Unknown",color:"#f3f4f6"},branchName:"",hiddenStems:{},hiddenQi:{},tenGod:null,isDayMaster:!1,isUnknown:!0,isEmpty:!0,stemTransformations:[],branchTransformations:[],stemCombinations:[],branchCombinations:[],stemNegatives:[],branchNegatives:[],branchWealthStorage:[]}),k=(0,n.useMemo)(()=>{var e,t,a,l,i,n,r,o,d;let c=w(h("comparison.pillar_labels.hourly"));if((null==s?void 0:null===(e=s.analysis_info)||void 0===e?void 0:e.has_hourly)&&(null==s?void 0:s.hs_hl)&&(null==s?void 0:s.eb_hl)){let e=j("hs_hl","eb_hl",h("comparison.pillar_labels.hourly"));e&&(e.isHourlyLuck=!0,c=e)}let u=w(h("comparison.pillar_labels.daily"));if((null==s?void 0:null===(t=s.analysis_info)||void 0===t?void 0:t.has_daily)&&(null==s?void 0:s.hs_dl)&&(null==s?void 0:s.eb_dl)){let e=j("hs_dl","eb_dl",h("comparison.pillar_labels.daily"));e&&(e.isDailyLuck=!0,u=e)}let m=w(h("comparison.pillar_labels.monthly"));if((null==s?void 0:null===(a=s.analysis_info)||void 0===a?void 0:a.has_monthly)&&(null==s?void 0:s.hs_ml)&&(null==s?void 0:s.eb_ml)){let e=j("hs_ml","eb_ml",h("comparison.pillar_labels.monthly"));e&&(e.isMonthlyLuck=!0,m=e)}let v=w(h("comparison.pillar_labels.annual"));if((null==s?void 0:null===(l=s.analysis_info)||void 0===l?void 0:l.year)&&(null==s?void 0:s.hs_yl)&&(null==s?void 0:s.eb_yl)){let e=j("hs_yl","eb_yl",h("comparison.pillar_labels.annual"));e&&(e.isAnnualLuck=!0,e.year=s.analysis_info.year,v=e)}let x=w(h("comparison.pillar_labels.ten_year"));if((null==s?void 0:null===(i=s.analysis_info)||void 0===i?void 0:i.has_luck_pillar)&&(null==s?void 0:s.hs_10yl)&&(null==s?void 0:s.eb_10yl)){let e=j("hs_10yl","eb_10yl",h("comparison.pillar_labels.ten_year"));if(e){e.isLuckPillar=!0,e.is10YrLuck=!0;let t=(null===(n=s.hs_10yl)||void 0===n?void 0:n.misc)||(null===(r=s.eb_10yl)||void 0===r?void 0:r.misc);t&&(e.timing={start_year:parseInt((null===(o=t.start_date)||void 0===o?void 0:o.split("-")[0])||"0"),end_year:parseInt((null===(d=t.end_date)||void 0===d?void 0:d.split("-")[0])||"0"),start_age:t.start_age||0,end_age:t.end_age||10}),x=e}}return[c,u,m,v,x]},[s,h]);(0,n.useMemo)(()=>{var e,t,a,l;let i=[];if((null==s?void 0:null===(e=s.analysis_info)||void 0===e?void 0:e.year)&&(null==s?void 0:s.hs_yl)&&(null==s?void 0:s.eb_yl)){let e=j("hs_yl","eb_yl","Annual 年運");e&&(e.isAnnualLuck=!0,e.year=s.analysis_info.year,i.push(e))}if((null==s?void 0:null===(t=s.analysis_info)||void 0===t?void 0:t.has_monthly)&&(null==s?void 0:s.hs_ml)&&(null==s?void 0:s.eb_ml)){let e=j("hs_ml","eb_ml","Monthly 月運");e&&(e.isMonthlyLuck=!0,i.push(e))}if((null==s?void 0:null===(a=s.analysis_info)||void 0===a?void 0:a.has_daily)&&(null==s?void 0:s.hs_dl)&&(null==s?void 0:s.eb_dl)){let e=j("hs_dl","eb_dl","Daily 日運");e&&(e.isDailyLuck=!0,i.push(e))}if((null==s?void 0:null===(l=s.analysis_info)||void 0===l?void 0:l.has_hourly)&&(null==s?void 0:s.hs_hl)&&(null==s?void 0:s.eb_hl)){let e=j("hs_hl","eb_hl","Hourly 時運");e&&(e.isHourlyLuck=!0,i.push(e))}return i},[s]);let C=(0,n.useMemo)(()=>{let e=[];if((null==s?void 0:s.hs_ty)||(null==s?void 0:s.eb_ty)){let t=j("hs_ty","eb_ty",h("talisman.pillar_labels.year"));t&&(t.isTalisman=!0,t.isTalismanYear=!0,e.push(t))}if((null==s?void 0:s.hs_tm)||(null==s?void 0:s.eb_tm)){let t=j("hs_tm","eb_tm",h("talisman.pillar_labels.month"));t&&(t.isTalisman=!0,t.isTalismanMonth=!0,e.push(t))}if((null==s?void 0:s.hs_td)||(null==s?void 0:s.eb_td)){let t=j("hs_td","eb_td",h("talisman.pillar_labels.day"));t&&(t.isTalisman=!0,t.isTalismanDay=!0,e.push(t))}if((null==s?void 0:s.hs_th)||(null==s?void 0:s.eb_th)){let t=j("hs_th","eb_th",h("talisman.pillar_labels.hour"));t&&(t.isTalisman=!0,t.isTalismanHour=!0,e.push(t))}return e},[s,h]),W=(0,n.useMemo)(()=>{let e=[];if((null==s?void 0:s.hs_o1)||(null==s?void 0:s.eb_o1)){let t=j("hs_o1","eb_o1",h("location.pillar_labels.overseas_1"));t&&(t.isLocation=!0,t.isOverseas=!0,e.push(t))}if((null==s?void 0:s.hs_o2)||(null==s?void 0:s.eb_o2)){let t=j("hs_o2","eb_o2",h("location.pillar_labels.overseas_2"));t&&(t.isLocation=!0,t.isOverseas=!0,e.push(t))}if((null==s?void 0:s.hs_b1)||(null==s?void 0:s.eb_b1)){let t=j("hs_b1","eb_b1",h("location.pillar_labels.birthplace_1"));t&&(t.isLocation=!0,t.isBirthplace=!0,e.push(t))}if((null==s?void 0:s.hs_b2)||(null==s?void 0:s.eb_b2)){let t=j("hs_b2","eb_b2",h("location.pillar_labels.birthplace_2"));t&&(t.isLocation=!0,t.isBirthplace=!0,e.push(t))}if((null==s?void 0:s.hs_b3)||(null==s?void 0:s.eb_b3)){let t=j("hs_b3","eb_b3",h("location.pillar_labels.birthplace_3"));t&&(t.isLocation=!0,t.isBirthplace=!0,e.push(t))}if((null==s?void 0:s.hs_b4)||(null==s?void 0:s.eb_b4)){let t=j("hs_b4","eb_b4",h("location.pillar_labels.birthplace_4"));t&&(t.isLocation=!0,t.isBirthplace=!0,e.push(t))}return e},[s,h]),D=r?N:[],S=c||o?k:[],E=u?C:[],M=m?W:[],L=D.length,F=L+S.length,I=F+E.length;return D.length>0||S.length>0||E.length>0||M.length>0?(0,l.jsx)("div",{className:"relative",children:(0,l.jsxs)("div",{className:"relative w-full",children:[(0,l.jsxs)("div",{className:"flex gap-0 items-center flex-wrap",children:[D.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"stem",index:0+t,mappings:y,hoveredInteractionId:f,onHoverInteraction:_},"stem-".concat(t))),S.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"stem",index:L+t,mappings:y,isLuck:!0,isEmpty:e.isEmpty,hoveredInteractionId:f,onHoverInteraction:_},"luck-stem-".concat(t))),S.length>0&&M.length>0&&(0,l.jsx)("div",{className:"luck-divider self-stretch bg-gradient-to-b from-transparent to-transparent opacity-70 ".concat((null===(a=M[0])||void 0===a?void 0:a.isOverseas)?"via-blue-500":"via-amber-500")}),M.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"stem",index:I+t,mappings:y,isLocation:!0,isOverseas:e.isOverseas,isBirthplace:e.isBirthplace,hoveredInteractionId:f,onHoverInteraction:_},"location-stem-".concat(t))),E.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"stem",index:F+t,mappings:y,isTalisman:!0,hoveredInteractionId:f,onHoverInteraction:_},"talisman-stem-".concat(t)))]}),(0,l.jsxs)("div",{className:"flex gap-0 overflow-visible items-stretch",children:[D.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"branch",index:0+t,mappings:y,hoveredInteractionId:f,onHoverInteraction:_},"branch-".concat(t))),S.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"branch",index:L+t,mappings:y,isLuck:!0,isEmpty:e.isEmpty,hoveredInteractionId:f,onHoverInteraction:_},"luck-branch-".concat(t))),S.length>0&&M.length>0&&(0,l.jsx)("div",{className:"luck-divider self-stretch bg-gradient-to-b from-transparent to-transparent opacity-70 ".concat((null===(i=M[0])||void 0===i?void 0:i.isOverseas)?"via-blue-500":"via-amber-500")}),M.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"branch",index:I+t,mappings:y,isLocation:!0,isOverseas:e.isOverseas,isBirthplace:e.isBirthplace,hoveredInteractionId:f,onHoverInteraction:_},"location-branch-".concat(t))),E.map((e,t)=>(0,l.jsx)(v,{pillar:e,type:"branch",index:F+t,mappings:y,isTalisman:!0,hoveredInteractionId:f,onHoverInteraction:_},"talisman-branch-".concat(t)))]})]})}):null}let g=["Wood","Fire","Earth","Metal","Water"],f={Wood:"tui-text-wood",Fire:"tui-text-fire",Earth:"tui-text-earth",Metal:"tui-text-metal",Water:"tui-text-water"},_={Wood:"tui-text-wood-yin",Fire:"tui-text-fire-yin",Earth:"tui-text-earth-yin",Metal:"tui-text-metal-yin",Water:"tui-text-water-yin"},j={Jia:{element:"Wood",polarity:"yang"},Yi:{element:"Wood",polarity:"yin"},Bing:{element:"Fire",polarity:"yang"},Ding:{element:"Fire",polarity:"yin"},Wu:{element:"Earth",polarity:"yang"},Ji:{element:"Earth",polarity:"yin"},Geng:{element:"Metal",polarity:"yang"},Xin:{element:"Metal",polarity:"yin"},Ren:{element:"Water",polarity:"yang"},Gui:{element:"Water",polarity:"yin"}},N={Wood:"木",Fire:"火",Earth:"土",Metal:"金",Water:"水"},w={Wood:{Wood:"Self",Fire:"Output",Earth:"Wealth",Metal:"Officer",Water:"Resource"},Fire:{Wood:"Resource",Fire:"Self",Earth:"Output",Metal:"Wealth",Water:"Officer"},Earth:{Wood:"Officer",Fire:"Resource",Earth:"Self",Metal:"Output",Water:"Wealth"},Metal:{Wood:"Wealth",Fire:"Officer",Earth:"Resource",Metal:"Self",Water:"Output"},Water:{Wood:"Output",Fire:"Wealth",Earth:"Officer",Metal:"Resource",Water:"Self"}};function k(e){let t={Wood:{total:0,yang:0,yin:0},Fire:{total:0,yang:0,yin:0},Earth:{total:0,yang:0,yin:0},Metal:{total:0,yang:0,yin:0},Water:{total:0,yang:0,yin:0}};for(let[a,l]of Object.entries(e)){let e=j[a];e&&(t[e.element].total+=l,t[e.element][e.polarity]+=l)}return t}function C(e){var t;let{chartData:a}=e;(0,d.T)("elements");let i=null==a?void 0:a.daymaster_analysis,s=(null==i?void 0:i.daymaster)||"",r=s.includes("Wood")?"Wood":s.includes("Fire")?"Fire":s.includes("Earth")?"Earth":s.includes("Metal")?"Metal":s.includes("Water")?"Water":"",o=(0,n.useMemo)(()=>{let e=(null==a?void 0:a.natal_element_score)||(null==a?void 0:a.base_element_score)||{},t=(null==a?void 0:a.post_element_score)||(null==a?void 0:a.advanced_post_elements)||e,l=k(e),i=k(t),s=g.reduce((e,t)=>{var a;return e+((null===(a=l[t])||void 0===a?void 0:a.total)||0)},0),n=g.reduce((e,t)=>{var a;return e+((null===(a=i[t])||void 0===a?void 0:a.total)||0)},0);return{elements:g.map(e=>{var t;let a=l[e]||{total:0,yang:0,yin:0},o=i[e]||{total:0,yang:0,yin:0},d=s>0?a.total/s*100:0,c=n>0?o.total/n*100:0,u=r&&(null===(t=w[r])||void 0===t?void 0:t[e])||"",m=n!==s?o:a;return{name:e,natalPct:d,postPct:c,change:c-d,relationship:u,yangRatio:m.total>0?m.yang/m.total:.5,yinRatio:m.total>0?m.yin/m.total:.5}}),natalTotal:s,postTotal:n,hasPost:n!==s}},[a,r]);if(!i)return null;let c=f[r]||"tui-text";return(0,l.jsxs)("div",{className:"tui-frame mt-2",children:[(0,l.jsxs)("div",{className:"tui-frame-title flex items-center justify-between",children:[(0,l.jsx)("span",{children:"WU XING 五行"}),(0,l.jsxs)("span",{children:["DM: ",(0,l.jsx)("span",{className:c,children:N[r]})," ",(0,l.jsxs)("span",{className:"Strong"===i.chart_type?"tui-text-wood":"tui-text-fire",children:[i.chart_type," ",null===(t=i.daymaster_percentage)||void 0===t?void 0:t.toFixed(0),"%"]})]})]}),(0,l.jsx)("div",{className:"p-2 space-y-1 font-mono",children:o.elements.map(e=>{let t=f[e.name]||"tui-text",a=Math.abs(e.change)>.5,i=o.hasPost?e.postPct:e.natalPct;return(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)("span",{className:"w-12 ".concat(t),children:[N[e.name]," ",e.name.substring(0,2)]}),(0,l.jsx)("span",{className:"tui-bar",children:(()=>{let a=function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16,l=Math.round(e/100*a),i=Math.round(l*t);return{yang:"█".repeat(i),yin:"█".repeat(l-i),empty:"░".repeat(a-l)}}(i,e.yangRatio,16),s=_[e.name]||t;return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("span",{className:t,children:a.yang}),(0,l.jsx)("span",{className:s,children:a.yin}),(0,l.jsx)("span",{className:"tui-text-muted",children:a.empty})]})})()}),(0,l.jsxs)("span",{className:"w-8 text-right tui-text-dim",children:[Math.round(i),"%"]}),o.hasPost&&a&&(0,l.jsxs)("span",{className:e.change>0?"tui-text-wood":"tui-text-fire",children:[e.change>0?"▲":"▼",Math.abs(Math.round(e.change))]}),(0,l.jsx)("span",{className:"w-16 text-right tui-text-muted",children:e.relationship})]},e.name)})}),(0,l.jsx)("div",{className:"border-t tui-border-color px-2 py-1 tui-text-muted text-center",children:o.hasPost?"Post-interaction":"Natal"})]})}let W={h:{bg:"#fef3c7",text:"#92400e",border:"#f59e0b"},d:{bg:"#f3e8ff",text:"#7e22ce",border:"#a855f7"},m:{bg:"#dbeafe",text:"#1e40af",border:"#3b82f6"},y:{bg:"#dcfce7",text:"#166534",border:"#22c55e"},"10yl":{bg:"#fce7f3",text:"#9d174d",border:"#ec4899"},yl:{bg:"#e0e7ff",text:"#3730a3",border:"#6366f1"},ml:{bg:"#cffafe",text:"#0e7490",border:"#06b6d4"},dl:{bg:"#fef9c3",text:"#854d0e",border:"#eab308"},hl:{bg:"#fed7aa",text:"#9a3412",border:"#f97316"},ty:{bg:"#f1f5f9",text:"#475569",border:"#94a3b8"},tm:{bg:"#f1f5f9",text:"#475569",border:"#94a3b8"},td:{bg:"#f1f5f9",text:"#475569",border:"#94a3b8"},th:{bg:"#f1f5f9",text:"#475569",border:"#94a3b8"},unknown:{bg:"#f3f4f6",text:"#374151",border:"#9ca3af"}},D={hs:"干",eb:"支"};function S(e){let{text:t,nodeType:a,position:i}=e,s=W[i||"unknown"]||W.unknown,n=a?D[a]:"";return(0,l.jsxs)("span",{className:"inline-flex items-center gap-0.5 px-1 py-0.5 rounded text-[9px] font-medium",style:{backgroundColor:s.bg,color:s.text,border:"1px solid ".concat(s.border)},children:[n&&(0,l.jsx)("span",{className:"opacity-60",children:n}),(0,l.jsx)("span",{children:t})]})}let E={meeting:"3M",triangle:"3H",harmony:"6H",half_meeting:"HM",half_combo:"HC",arch:"AH",stem_combo:"SC",clash:"CL",punishment:"XG",harm:"HI",destruction:"PO",stem_conflict:"KE",excess:"EX",deficiency:"DF",strong:"ST",weak:"WK",wealth_open:"WO",wealth_closed:"WC",season:"SN",flow:"FL"},M={positive:{bg:"#dcfce7",border:"#22c55e",text:"#166534"},negative:{bg:"#fee2e2",border:"#ef4444",text:"#991b1b"},neutral:{bg:"var(--tui-bg-alt)",border:"var(--tui-border)",text:"var(--tui-fg)"}};function L(e){var t,a,i;let{narrative:s,isExpanded:n,onToggle:r,mappings:o}=e,d=M[s.polarity||"neutral"]||M.neutral,c=E[s.icon]||(null===(t=s.type)||void 0===t?void 0:t.slice(0,2).toUpperCase())||"??",u=s.element?null==o?void 0:null===(i=o.elements)||void 0===i?void 0:null===(a=i[s.element])||void 0===a?void 0:a.hex_color:null;return(0,l.jsxs)("div",{className:"narrative-card",style:{backgroundColor:d.bg,borderColor:d.border,borderWidth:"1px",borderStyle:"solid"},children:[(0,l.jsxs)("button",{onClick:r,className:"w-full flex items-start gap-2 text-left p-2",children:[(0,l.jsx)("div",{className:"shrink-0 w-7 h-7 flex items-center justify-center rounded text-[10px] font-bold",style:{backgroundColor:u||d.border,color:"#fff"},children:c}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,l.jsx)("span",{className:"text-xs font-semibold",style:{color:d.text},children:s.title}),s.element&&(0,l.jsx)("span",{className:"px-1 py-0.5 text-[9px] rounded",style:{backgroundColor:u?u+"30":"#e5e7eb",color:u||"#374151"},children:s.element}),s.points&&(0,l.jsx)("span",{className:"text-[9px] tui-text-muted font-mono",children:s.points})]}),(0,l.jsx)("p",{className:"text-[11px] tui-text-dim mt-0.5 line-clamp-2",children:s.summary}),s.pillar_refs&&s.pillar_refs.length>0&&(0,l.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:s.pillar_refs.map((e,t)=>(0,l.jsx)(S,{text:e.abbrev,nodeType:e.node_type,position:e.position},t))})]}),(0,l.jsx)("div",{className:"shrink-0 tui-text-muted text-xs",children:n?"▲":"▼"})]}),n&&(0,l.jsxs)("div",{className:"px-2 pb-2 pt-0 border-t tui-border-color mt-1",children:[s.detail&&(0,l.jsx)("p",{className:"text-[11px] tui-text-dim mt-1.5 leading-relaxed",children:s.detail}),s.meaning&&(0,l.jsxs)("div",{className:"mt-2 p-1.5 tui-bg-alt rounded text-[10px]",children:[(0,l.jsx)("span",{className:"font-semibold tui-text-dim",children:"Meaning: "}),(0,l.jsx)("span",{className:"tui-text-dim",children:s.meaning})]}),s.advice&&(0,l.jsxs)("div",{className:"mt-1.5 p-1.5 rounded text-[10px]",style:{background:"color-mix(in srgb, var(--tui-water) 15%, var(--tui-bg))"},children:[(0,l.jsx)("span",{className:"font-semibold",style:{color:"var(--tui-water)"},children:"Advice: "}),(0,l.jsx)("span",{style:{color:"var(--tui-water)"},children:s.advice})]}),s.status_detail&&(0,l.jsx)("div",{className:"mt-1.5 text-[10px] tui-text-muted italic",children:s.status_detail}),s.element_note&&(0,l.jsx)("div",{className:"mt-1.5 text-[10px] p-1 rounded",style:{background:"color-mix(in srgb, var(--tui-accent-orange) 15%, var(--tui-bg))",color:"var(--tui-accent-orange)"},children:s.element_note}),s.shen_sha&&s.shen_sha.length>0&&(0,l.jsxs)("div",{className:"mt-2 text-[10px]",children:[(0,l.jsx)("span",{className:"font-semibold",style:{color:"var(--tui-accent-purple)"},children:"Special Stars: "}),(0,l.jsx)("span",{style:{color:"var(--tui-accent-purple)"},children:s.shen_sha.map(e=>"".concat(e.chinese_name||e.name)).join(", ")}),s.shen_sha_note&&(0,l.jsxs)("span",{className:"tui-text-muted ml-1",children:["- ",s.shen_sha_note]})]}),s.dm_spouse_relationship&&(0,l.jsxs)("div",{className:"mt-2 p-2 rounded",style:{background:"color-mix(in srgb, var(--tui-accent-pink) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-accent-pink) 40%, var(--tui-bg))"},children:[(0,l.jsx)("div",{className:"text-[10px] font-semibold mb-1.5",style:{color:"var(--tui-accent-pink)"},children:"❤️ Spouse Palace Chain Analysis"}),(0,l.jsx)("div",{className:"text-[10px] leading-relaxed",style:{color:"var(--tui-accent-pink)"},children:s.dm_spouse_relationship.dm_spouse_meaning}),s.dm_spouse_relationship.spouse_star_meaning&&(0,l.jsx)("div",{className:"mt-1.5 text-[10px]",style:{color:"var(--tui-accent-pink)"},children:s.dm_spouse_relationship.spouse_star_meaning}),s.dm_spouse_relationship.chain_interpretation&&(0,l.jsx)("div",{className:"mt-2 p-1.5 tui-bg-alt rounded text-[10px] font-medium",style:{color:"var(--tui-accent-pink)"},children:s.dm_spouse_relationship.chain_interpretation})]}),s.branch_chain_analyses&&s.branch_chain_analyses.length>0&&(0,l.jsxs)("details",{className:"mt-2",children:[(0,l.jsxs)("summary",{className:"text-[10px] font-semibold cursor-pointer",style:{color:"var(--tui-accent-purple)"},children:["\uD83D\uDD17 Detailed Chain Analysis (",s.branch_chain_analyses.length," branches)"]}),(0,l.jsx)("div",{className:"mt-2 space-y-2",children:s.branch_chain_analyses.map((e,t)=>{var a,i,s;return(0,l.jsxs)("div",{className:"p-2 tui-bg-alt tui-frame rounded",children:[(0,l.jsxs)("div",{className:"text-[10px] font-semibold mb-1",style:{color:"var(--tui-accent-purple)"},children:["[",e.branch,"] ",null===(a=e.pillar_type)||void 0===a?void 0:a.toUpperCase()," Pillar"]}),null===(s=e.analysis)||void 0===s?void 0:null===(i=s.chains)||void 0===i?void 0:i.map((e,t)=>{var a,i,s,n;return(0,l.jsxs)("div",{className:"mt-1 text-[9px]",children:["element"===e.type&&(0,l.jsxs)("div",{className:"flex items-center gap-1 tui-text-dim",children:[(0,l.jsx)("span",{className:"font-medium",style:{color:"var(--tui-wood)"},children:"Element:"}),(0,l.jsxs)("span",{children:[e.element," (",null===(a=e.percentage)||void 0===a?void 0:a.toFixed(1),"%)"]}),(0,l.jsx)("span",{style:{color:e.favorable?"var(--tui-wood)":"var(--tui-earth)"},children:e.favorable?"✓ favorable":"⚠ unfavorable"})]}),"ten_god"===e.type&&(0,l.jsxs)("div",{className:"tui-text-dim",children:[(0,l.jsx)("span",{className:"font-medium",style:{color:"var(--tui-water)"},children:"Ten God:"}),(0,l.jsx)("span",{className:"ml-1",children:e.name_en}),e.is_excess&&(0,l.jsxs)("span",{className:"ml-1",style:{color:"var(--tui-earth)"},children:["(excess: ",null===(i=e.excess_traits)||void 0===i?void 0:i.join(", "),")"]})]}),"shen_sha"===e.type&&(0,l.jsxs)("div",{className:"p-1 rounded mt-1",style:{background:"color-mix(in srgb, var(--tui-accent-purple) 15%, var(--tui-bg))",color:"var(--tui-accent-purple)"},children:[(0,l.jsxs)("div",{className:"font-medium",children:["⭐ ",e.chinese," / ",e.english]}),(0,l.jsx)("div",{className:"mt-0.5",children:e.base_meaning}),(null===(s=e.contextual_meanings)||void 0===s?void 0:s.length)>0&&(0,l.jsxs)("div",{className:"mt-0.5 font-medium",children:["→ ",e.contextual_meanings.join(" → ")]})]}),"qi_phase"===e.type&&(0,l.jsxs)("div",{className:"tui-text-dim",children:[(0,l.jsx)("span",{className:"font-medium",style:{color:"var(--tui-accent-teal)"},children:"Qi Phase:"}),(0,l.jsxs)("span",{className:"ml-1",children:[e.chinese," (",e.english,")"]}),(0,l.jsxs)("span",{className:"ml-1 tui-text-muted",children:["- ",e.base_meaning]}),e.is_storage&&(0,l.jsxs)("div",{className:"mt-0.5 p-1 rounded",style:{background:"var(--tui-earth)",color:"var(--tui-bg)"},children:["\uD83D\uDCE6 ",e.storage_meaning]})]}),"storage"===e.type&&(0,l.jsxs)("div",{className:"p-1 rounded mt-1",style:{background:"color-mix(in srgb, var(--tui-accent-orange) 15%, var(--tui-bg))",color:"var(--tui-accent-orange)"},children:[(0,l.jsxs)("div",{className:"font-medium",children:["\uD83C\uDFDB️ Storage: ",e.stores," element"]}),e.is_wealth_storage&&(0,l.jsxs)("div",{className:"mt-0.5",children:["\uD83D\uDCB0 Wealth Storage | Wealth: ",null===(n=e.wealth_percentage)||void 0===n?void 0:n.toFixed(1),"% (",e.wealth_strength,")"]}),(0,l.jsx)("div",{className:"mt-0.5",children:e.opener_meaning})]})]},t)})]},t)})})]}),s.master_chain_narrative&&(0,l.jsxs)("div",{className:"mt-2 p-2 tui-bg-alt tui-frame rounded",children:[(0,l.jsx)("div",{className:"text-[9px] font-semibold tui-text-dim mb-1",children:"\uD83D\uDCDC Chain Summary"}),(0,l.jsx)("div",{className:"text-[9px] tui-text leading-relaxed",children:s.master_chain_narrative})]}),s.life_area_impact&&(0,l.jsx)("div",{className:"mt-1.5 text-[10px] tui-text-dim tui-bg-alt p-1.5 rounded",children:s.life_area_impact}),s.branches_display&&(0,l.jsxs)("div",{className:"mt-1.5 text-[10px] tui-text-muted",children:[(0,l.jsx)("span",{className:"font-medium",children:"Branches: "}),(0,l.jsx)("span",{className:"font-mono",children:s.branches_display})]}),(0,l.jsxs)("div",{className:"mt-2 flex items-center gap-3 text-[9px] tui-text-muted",children:[s.distance&&(0,l.jsxs)("span",{children:["Distance: ",s.distance]}),s.priority_score&&(0,l.jsxs)("span",{children:["Priority: ",s.priority_score]})]})]})]})}let F={Wood:{bg:"#dcfce7",text:"#166534",border:"#22c55e"},Fire:{bg:"#fee2e2",text:"#991b1b",border:"#ef4444"},Earth:{bg:"#fef3c7",text:"#92400e",border:"#f59e0b"},Metal:{bg:"#f3f4f6",text:"#374151",border:"#9ca3af"},Water:{bg:"#dbeafe",text:"#1e40af",border:"#3b82f6"}},I={Wood:"木",Fire:"火",Earth:"土",Metal:"金",Water:"水"};function T(e){let{element:t,colors:a,numbers:i,direction:s}=e,n=F[t]||F.Earth,r=I[t]||t;return(0,l.jsxs)("div",{className:"remedy-badge p-2 rounded-lg text-center min-w-[80px]",style:{backgroundColor:n.bg,border:"2px solid ".concat(n.border)},children:[(0,l.jsxs)("div",{className:"text-xs font-bold mb-1",style:{color:n.text},children:[(0,l.jsx)("span",{className:"mr-1",children:r}),(0,l.jsx)("span",{children:t})]}),(0,l.jsxs)("div",{className:"space-y-0.5 text-[9px]",style:{color:n.text},children:[a&&a.length>0&&(0,l.jsxs)("div",{className:"flex items-center justify-center gap-1",children:[(0,l.jsx)("span",{className:"opacity-60",children:"Color:"}),(0,l.jsx)("span",{className:"font-medium capitalize",children:a[0]})]}),i&&i.length>0&&(0,l.jsxs)("div",{className:"flex items-center justify-center gap-1",children:[(0,l.jsx)("span",{className:"opacity-60",children:"Lucky #:"}),(0,l.jsx)("span",{className:"font-mono font-medium",children:i.join(", ")})]}),s&&(0,l.jsxs)("div",{className:"flex items-center justify-center gap-1",children:[(0,l.jsx)("span",{className:"opacity-60",children:"Dir:"}),(0,l.jsx)("span",{className:"font-medium",children:s})]})]}),(0,l.jsx)("div",{className:"mt-1 pt-1 border-t text-[8px] opacity-60",style:{borderColor:n.border},children:"Favorable Element"})]})}let O={combination:{label:"Combinations",labelZh:"组合",color:"#8b5cf6",bgColor:"#f3e8ff"},conflict:{label:"Conflicts",labelZh:"冲突",color:"#ef4444",bgColor:"#fee2e2"},balance:{label:"Element Balance",labelZh:"五行平衡",color:"#f59e0b",bgColor:"#fef3c7"},daymaster:{label:"Daymaster",labelZh:"日主",color:"#3b82f6",bgColor:"#dbeafe"},wealth:{label:"Wealth",labelZh:"财运",color:"#10b981",bgColor:"#d1fae5"},seasonal:{label:"Seasonal",labelZh:"季节",color:"#6366f1",bgColor:"#e0e7ff"},energy:{label:"Energy Flow",labelZh:"能量",color:"#06b6d4",bgColor:"#cffafe"}},B=["daymaster","combination","conflict","balance","wealth","seasonal","energy"];function R(e){let{chartData:t}=e,[a,i]=(0,n.useState)(null),[s,r]=(0,n.useState)(!1),o=null==t?void 0:t.narrative_analysis,d=(0,n.useMemo)(()=>(null==o?void 0:o.narratives_by_category)?o.narratives_by_category:{},[o]),c=null==o?void 0:o.summary,u=null==o?void 0:o.quick_remedies,m=(null==o?void 0:o.remedies)||[],h=(0,n.useMemo)(()=>B.filter(e=>d[e]&&d[e].length>0),[d]),v=s?h:h.slice(0,3);if(!o)return null;let x=e=>{i(a===e?null:e)};return(0,l.jsx)("div",{className:"narrative-panel",children:(0,l.jsxs)("div",{className:"narrative-panel-inner",children:[(0,l.jsxs)("div",{className:"flex items-start justify-between mb-3",children:[(0,l.jsxs)("div",{className:"flex-1",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold tui-text mb-1",children:"Chart Interpretation"}),c&&(0,l.jsx)("p",{className:"text-xs tui-text-dim leading-relaxed",children:c.text})]}),u&&u.favorable_element&&(0,l.jsx)("div",{className:"ml-3 shrink-0",children:(0,l.jsx)(T,{element:u.favorable_element,colors:u.lucky_colors,numbers:u.lucky_numbers,direction:u.favorable_direction})})]}),(null==c?void 0:c.outlook)&&(0,l.jsx)("div",{className:"mb-3 p-2 tui-bg-alt tui-frame rounded text-xs tui-text-dim",children:c.outlook}),(0,l.jsx)("div",{className:"space-y-3",children:v.map(e=>{let i=O[e],s=d[e]||[];return 0===s.length?null:(0,l.jsxs)("div",{className:"narrative-category",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 mb-1.5 pb-1 border-b",style:{borderColor:i.color+"40"},children:[(0,l.jsx)("span",{className:"px-1.5 py-0.5 text-[10px] font-semibold rounded",style:{backgroundColor:i.bgColor,color:i.color},children:i.label}),(0,l.jsxs)("span",{className:"text-[10px] tui-text-muted",children:[s.length," ",1===s.length?"item":"items"]})]}),(0,l.jsx)("div",{className:"space-y-1.5",children:s.map(e=>(0,l.jsx)(L,{narrative:e,isExpanded:a===e.id,onToggle:()=>x(e.id),mappings:null==t?void 0:t.mappings},e.id))})]},e)})}),h.length>3&&(0,l.jsx)("button",{onClick:()=>r(!s),className:"mt-3 w-full py-1.5 text-xs tui-text-dim tui-frame rounded hover:tui-bg-alt transition-colors",children:s?"Show Less":"Show ".concat(h.length-3," More Categories")}),m.length>0&&(0,l.jsxs)("details",{className:"mt-3",children:[(0,l.jsxs)("summary",{className:"text-xs font-semibold tui-text-dim cursor-pointer",children:["Detailed Remedy Recommendations (",m.length,")"]}),(0,l.jsx)("div",{className:"mt-2 space-y-2",children:m.map((e,t)=>{var a,i,s,n,r,o,d;return(0,l.jsxs)("div",{className:"p-2 rounded text-xs",style:{background:"color-mix(in srgb, var(--tui-wood) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-wood) 40%, var(--tui-bg))"},children:[(0,l.jsx)("div",{className:"font-semibold mb-1",style:{color:"var(--tui-wood)"},children:e.title}),(0,l.jsx)("p",{className:"mb-2",style:{color:"var(--tui-wood)"},children:e.intro}),e.recommendations&&(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-2 text-[10px]",children:[(null===(i=e.recommendations.colors)||void 0===i?void 0:null===(a=i.use)||void 0===a?void 0:a.length)>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium tui-text-dim",children:"Colors: "}),(0,l.jsx)("span",{className:"tui-text",children:e.recommendations.colors.use.join(", ")})]}),(null===(s=e.recommendations.lucky_numbers)||void 0===s?void 0:s.length)>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium tui-text-dim",children:"Numbers: "}),(0,l.jsx)("span",{className:"tui-text",children:e.recommendations.lucky_numbers.join(", ")})]}),(null===(r=e.recommendations.directions)||void 0===r?void 0:null===(n=r.favorable)||void 0===n?void 0:n.length)>0&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium tui-text-dim",children:"Directions: "}),(0,l.jsx)("span",{className:"tui-text",children:e.recommendations.directions.favorable.join(", ")})]}),e.recommendations.favorable_season&&(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"font-medium tui-text-dim",children:"Season: "}),(0,l.jsx)("span",{className:"tui-text",children:e.recommendations.favorable_season})]})]}),(null===(d=e.recommendations)||void 0===d?void 0:null===(o=d.activities)||void 0===o?void 0:o.length)>0&&(0,l.jsxs)("div",{className:"mt-2 text-[10px]",children:[(0,l.jsx)("span",{className:"font-medium tui-text-dim",children:"Suggested Activities:"}),(0,l.jsx)("ul",{className:"mt-0.5 list-disc list-inside tui-text-dim",children:e.recommendations.activities.map((e,t)=>(0,l.jsx)("li",{children:e},t))})]})]},t)})})]})]})})}let H={Wood:"#22c55e",Fire:"#ef4444",Earth:"#eab308",Metal:"#94a3b8",Water:"#3b82f6"},P={resource:"R",companion:"C",output:"O",wealth:"W",officer:"P"};function U(e){var t;let{chartData:a}=e,[i,s]=(0,n.useState)(null),[r,o]=(0,n.useState)(null),d=null==a?void 0:a.pillar_stories;if(!d)return null;let{minimap:c,pillar_stories:u}=d,m=e=>{s(e)},h=e=>{o(r===e?null:e)};return(0,l.jsxs)("div",{className:"pillar-story-panel",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold tui-text mb-3",children:"Chart Story (Node by Node)"}),(0,l.jsx)("div",{className:"minimap mb-4",children:(0,l.jsx)("div",{className:"flex justify-center gap-1",children:null==c?void 0:null===(t=c.pillars)||void 0===t?void 0:t.map(e=>{var t,a;return(0,l.jsxs)("div",{className:"minimap-pillar",children:[(0,l.jsx)("div",{className:"text-[9px] tui-text-muted text-center mb-0.5 uppercase",children:e.pillar.slice(0,2)}),(0,l.jsx)("div",{className:"minimap-cell ".concat(i===e.hs.node_id?"ring-2":""),style:{backgroundColor:H[e.hs.element]||"#e5e7eb","--tw-ring-color":"var(--tui-accent-purple)"},title:"".concat(e.hs.value," (").concat(e.hs.element,")"),children:(0,l.jsx)("span",{className:"text-[8px] font-bold text-white drop-shadow",children:null===(t=e.hs.value)||void 0===t?void 0:t.slice(0,2)})}),(0,l.jsx)("div",{className:"minimap-cell mt-0.5 ".concat(i===e.eb.node_id?"ring-2":""),style:{backgroundColor:H[e.eb.element]||"#e5e7eb","--tw-ring-color":"var(--tui-accent-purple)"},title:"".concat(e.eb.value," (").concat(e.eb.element,")"),children:(0,l.jsx)("span",{className:"text-[8px] font-bold text-white drop-shadow",children:null===(a=e.eb.value)||void 0===a?void 0:a.slice(0,2)})})]},e.pillar)})})}),(0,l.jsx)("div",{className:"space-y-1.5",children:null==u?void 0:u.map(e=>{var t,a,s,n;let o=i===e.node_id,d=r===e.node_id,c=H[e.element]||"#9ca3af";return(0,l.jsxs)("div",{className:"story-card ".concat(o?"ring-2":""),style:{"--tw-ring-color":"var(--tui-accent-purple)"},onMouseEnter:()=>m(e.node_id),onMouseLeave:()=>m(null),onClick:()=>h(e.node_id),children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("div",{className:"w-8 h-8 rounded flex items-center justify-center shrink-0",style:{backgroundColor:c},children:(0,l.jsx)("span",{className:"text-[10px] font-bold text-white",children:e.is_daymaster?"DM":P[e.ten_god_role]||"?"})}),(0,l.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,l.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,l.jsx)("span",{className:"text-xs font-semibold tui-text",children:e.node_name}),(0,l.jsxs)("span",{className:"text-[9px] px-1 py-0.5 rounded",style:{backgroundColor:c+"30",color:c},children:[e.element," ",null===(t=e.element_percentage)||void 0===t?void 0:t.toFixed(1),"%"]}),!e.is_favorable&&(0,l.jsx)("span",{className:"text-[9px]",style:{color:"var(--tui-accent-orange)"},children:"⚠"}),e.is_excessive&&(0,l.jsx)("span",{className:"text-[9px]",style:{color:"var(--tui-fire)"},children:"\uD83D\uDD25"})]}),(0,l.jsxs)("div",{className:"text-[10px] tui-text-dim",children:[e.ten_god_name,e.node_role&&" • ".concat(e.node_role)]})]}),(0,l.jsx)("div",{className:"tui-text-muted text-xs shrink-0",children:d?"▲":"▼"})]}),(0,l.jsxs)("div",{className:"mt-1.5 flex flex-wrap gap-1",children:[e.qi_phase&&(0,l.jsxs)("span",{className:"text-[9px] px-1.5 py-0.5 rounded",style:{background:"var(--tui-accent-teal)",color:"var(--tui-bg)"},children:[e.qi_phase.chinese," ",e.qi_phase.english]}),e.storage&&(0,l.jsxs)("span",{className:"text-[9px] px-1.5 py-0.5 rounded font-semibold",style:e.storage.is_wealth_storage?{background:"var(--tui-earth)",color:"var(--tui-bg)"}:{background:"var(--tui-bg-alt)",color:"var(--tui-fg-dim)"},children:[e.storage.is_wealth_storage?"\uD83D\uDCB0":"\uD83D\uDCE6"," ",e.storage.stores,"库"]}),null===(a=e.shen_sha)||void 0===a?void 0:a.map((e,t)=>(0,l.jsxs)("span",{className:"text-[9px] px-1.5 py-0.5 rounded",style:{background:"var(--tui-accent-purple)",color:"var(--tui-bg)"},children:["⭐ ",e.chinese]},t))]}),d&&(0,l.jsxs)("div",{className:"mt-2 pt-2 border-t tui-border-color text-[10px] space-y-1.5",children:[(0,l.jsxs)("div",{className:"tui-text-dim",children:[(0,l.jsx)("span",{className:"font-medium",children:"Represents: "}),e.node_represents]}),(0,l.jsxs)("div",{className:"tui-text-dim",children:[(0,l.jsxs)("span",{className:"font-medium",children:[e.ten_god_name,": "]}),e.ten_god_meaning]}),e.excess_meaning&&(0,l.jsxs)("div",{className:"p-1.5 rounded",style:{background:"var(--tui-fire)",color:"var(--tui-bg)"},children:[(0,l.jsx)("span",{className:"font-medium",children:"Excess Effect: "}),e.excess_meaning]}),e.qi_phase&&(0,l.jsxs)("div",{className:"tui-text-dim",children:[(0,l.jsxs)("span",{className:"font-medium",children:["Qi Phase (",e.qi_phase.chinese,"): "]}),e.qi_phase.meaning]}),e.storage&&(0,l.jsxs)("div",{className:"p-1.5 rounded",style:e.storage.is_wealth_storage?{background:"var(--tui-earth)",color:"var(--tui-bg)"}:{background:"var(--tui-bg-alt)",color:"var(--tui-fg-dim)"},children:[(0,l.jsx)("div",{className:"font-medium",children:e.storage.is_wealth_storage?"\uD83D\uDCB0 Wealth Storage!":"\uD83D\uDCE6 Storage Branch"}),(0,l.jsxs)("div",{children:["Stores ",e.storage.stores," • Opened by ",e.storage.opener," clash"]})]}),null===(s=e.shen_sha)||void 0===s?void 0:s.map((e,t)=>(0,l.jsxs)("div",{className:"p-1.5 rounded",style:{background:"var(--tui-accent-purple)",color:"var(--tui-bg)"},children:[(0,l.jsxs)("div",{className:"font-medium",children:["⭐ ",e.chinese," (",e.english,")"]}),(0,l.jsx)("div",{children:e.base_meaning})]},t)),(null===(n=e.interactions)||void 0===n?void 0:n.length)>0&&(0,l.jsxs)("div",{className:"tui-text-muted",children:[(0,l.jsx)("span",{className:"font-medium",children:"Interactions: "}),e.interactions.map(e=>e.type).join(", ")]})]})]},e.node_id)})})]})}function A(e,t){return e?"zh"===t?e.analysis_text_chinese||e.analysis_text||"":"id"===t?e.analysis_text_id||e.analysis_text||"":e.analysis_text||"":""}function q(e){var t,a,i,s,o,u,m,h,v,x,p,b,g,f,_,j,N,w,k,W,D,S,E,M,L,F;let{profileId:I,event:T,chartData:O,isLoading:B=!1,error:H=null,isNatal:P=!1,onDelete:q,onEventUpdate:Y}=e;(0,d.T)();let z=(0,d.T)("common"),G=(0,d.T)("lifeAspects.health"),K=(0,d.T)("lifeAspects.wealth"),Z=(0,d.T)("lifeAspects.learning"),Q=(0,d.T)("lifeAspects.ten_gods"),X=(0,c.bU)(),[J,$]=(0,n.useState)(!1),[V,ee]=(0,n.useState)(T.notes||""),[et,ea]=(0,n.useState)(!1),[el,ei]=(0,n.useState)(!1),es=(0,n.useRef)(null);(0,n.useEffect)(()=>{ee(T.notes||"")},[T.notes]),(0,n.useEffect)(()=>{J&&es.current&&(es.current.focus(),es.current.style.height="auto",es.current.style.height=es.current.scrollHeight+"px")},[J,V]);let en=async()=>{if(et)return;let e=V.trim();if(e===(T.notes||"")){$(!1);return}try{ea(!0);let t=await (0,r.Di)(I,T.id,{notes:e||null});null==Y||Y(t)}catch(e){console.error("Failed to save notes:",e),ee(T.notes||"")}finally{ea(!1),$(!1)}},er=(e,t)=>{let a="wealth"===t?K:Z;return({favorable:a("outlook.favorable"),neutral:a("outlook.neutral"),challenging:a("outlook.challenging")})[e]||e};return(0,l.jsxs)("div",{className:"tui-frame overflow-hidden",style:P?{borderColor:"var(--tui-accent-purple)"}:{},children:[(0,l.jsxs)("div",{className:"px-4 py-2",style:P?{background:"color-mix(in srgb, var(--tui-accent-purple) 15%, var(--tui-bg))"}:{background:"var(--tui-bg-alt)"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 flex-wrap",children:[(0,l.jsx)("span",{className:"font-semibold",style:P?{color:"var(--tui-accent-purple)"}:{color:"var(--tui-fg-dim)"},children:P?"Birth Chart":function(e){let t=[e.year.toString()];if(e.month){let a=new Date(2e3,e.month-1,1).toLocaleString("default",{month:"short"});t.push(a)}return e.day&&t.push(e.day.toString()),t.join(" - ")}(T)}),P&&(0,l.jsx)("span",{className:"text-xs px-2 py-0.5",style:{background:"var(--tui-accent-purple)",color:"var(--tui-bg)"},children:"Birth"}),(null==O?void 0:null===(t=O.hs_10yl)||void 0===t?void 0:t.misc)&&(0,l.jsxs)("span",{className:"text-xs tui-text-muted",children:["10Y: ",null===(a=O.hs_10yl.misc.start_date)||void 0===a?void 0:a.split("-")[0]," - ",null===(i=O.hs_10yl.misc.end_date)||void 0===i?void 0:i.split("-")[0]]})]}),!P&&q&&(0,l.jsx)("div",{className:"relative",children:el?(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)("span",{className:"text-xs tui-text-muted",children:[z("actions.delete"),"?"]}),(0,l.jsx)("button",{onClick:()=>{ei(!1),null==q||q()},className:"text-xs px-2 py-1",style:{background:"var(--tui-error)",color:"var(--tui-bg)"},children:z("actions.yes")}),(0,l.jsx)("button",{onClick:()=>ei(!1),className:"tui-btn text-xs px-2 py-1",children:z("actions.no")})]}):(0,l.jsx)("button",{onClick:()=>ei(!0),className:"tui-text-muted p-1",title:z("actions.delete"),children:(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})})]}),!P&&T.location&&(0,l.jsx)("div",{className:"text-xs tui-text-dim mt-1",children:T.location})]}),(0,l.jsx)("div",{className:"p-2",children:B?(0,l.jsxs)("div",{className:"py-8 text-center tui-text-muted",children:[(0,l.jsx)("div",{className:"inline-block animate-spin h-5 w-5 border-2 tui-border mr-2",style:{borderTopColor:"var(--tui-water)"}}),z("status.loading_chart")]}):H?(0,l.jsx)("div",{className:"py-4 px-3 text-sm",style:{background:"color-mix(in srgb, var(--tui-error) 10%, var(--tui-bg))",color:"var(--tui-error)"},children:H}):O?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(y,{chartData:O,showNatal:!0,showLuck:!1,showTalisman:!1,showLocation:!1}),!P&&(null==O?void 0:null===(s=O.analysis_info)||void 0===s?void 0:s.year)&&(0,l.jsx)("div",{className:"mt-1",children:(0,l.jsx)(y,{chartData:O,showNatal:!1,showLuck:!0,showTalisman:!1,showLocation:!1})}),(0,l.jsx)(C,{chartData:O}),P&&(null==O?void 0:O.pillar_stories)&&(0,l.jsx)(U,{chartData:O}),P&&(null==O?void 0:O.narrative_analysis)&&(0,l.jsxs)("details",{className:"mt-3",children:[(0,l.jsx)("summary",{className:"text-xs font-semibold tui-text-dim cursor-pointer p-2 tui-bg-alt tui-border",children:"Interaction Analysis (Advanced)"}),(0,l.jsx)(R,{chartData:O})]}),!P&&(null==O?void 0:null===(o=O.analysis_info)||void 0===o?void 0:o.year)&&(0,l.jsxs)("div",{className:"mt-3 space-y-2",children:[(null==O?void 0:null===(u=O.health_analysis)||void 0===u?void 0:u.pattern_engine)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-fire) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-fire) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-fire)"},children:G("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"critical"===O.health_analysis.pattern_engine.severity_level?"var(--tui-fire)":"major"===O.health_analysis.pattern_engine.severity_level?"var(--tui-accent-orange)":"moderate"===O.health_analysis.pattern_engine.severity_level?"var(--tui-earth)":"var(--tui-wood)",color:"var(--tui-bg)"},children:O.health_analysis.pattern_engine.severity_level||"balanced"})]}),null===(m=O.health_analysis.pattern_engine.recommendations)||void 0===m?void 0:m.map((e,t)=>(0,l.jsxs)("div",{className:"mt-1",style:{color:"var(--tui-fire)"},children:[(0,l.jsx)("span",{className:"font-medium",children:e.title}),": ",e.description]},t)),(null===(h=O.health_analysis.pattern_engine.top_patterns)||void 0===h?void 0:h.length)>0&&(0,l.jsx)("div",{className:"mt-2 text-xs px-2 py-1 rounded",style:{background:"color-mix(in srgb, var(--tui-fire) 25%, var(--tui-bg))",color:"var(--tui-fire)"},children:O.health_analysis.pattern_engine.top_patterns.slice(0,3).map((e,t)=>{var a;return(0,l.jsxs)("div",{children:[e.chinese_name,": ",null===(a=e.severity)||void 0===a?void 0:a.toFixed(0)," (",e.level,")"]},t)})}),!(null===(v=O.health_analysis.pattern_engine.recommendations)||void 0===v?void 0:v.length)&&O.health_analysis.analysis_text&&(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-fire)"},children:A(O.health_analysis,X)})]}),!(null==O?void 0:null===(x=O.health_analysis)||void 0===x?void 0:x.pattern_engine)&&(null==O?void 0:null===(p=O.health_analysis)||void 0===p?void 0:p.analysis_text)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-fire) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-fire) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-fire)"},children:G("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"severe"===O.health_analysis.severity_category?"var(--tui-fire)":"moderate"===O.health_analysis.severity_category?"var(--tui-accent-orange)":"mild"===O.health_analysis.severity_category?"var(--tui-earth)":"var(--tui-wood)",color:"var(--tui-bg)"},children:(F=O.health_analysis.severity_category||"balanced",({severe:G("severity.severe"),moderate:G("severity.moderate"),mild:G("severity.mild"),balanced:G("severity.balanced")})[F]||F)})]}),(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-fire)"},children:A(O.health_analysis,X)})]}),(null==O?void 0:null===(b=O.wealth_analysis)||void 0===b?void 0:b.pattern_engine)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-earth) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-earth) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-earth)"},children:K("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"critical"===O.wealth_analysis.pattern_engine.severity_level?"var(--tui-fire)":"major"===O.wealth_analysis.pattern_engine.severity_level?"var(--tui-accent-orange)":"moderate"===O.wealth_analysis.pattern_engine.severity_level?"var(--tui-earth)":"var(--tui-wood)",color:"var(--tui-bg)"},children:O.wealth_analysis.pattern_engine.severity_level||"balanced"})]}),null===(g=O.wealth_analysis.pattern_engine.recommendations)||void 0===g?void 0:g.map((e,t)=>(0,l.jsxs)("div",{className:"mt-1",style:{color:"var(--tui-earth)"},children:[(0,l.jsx)("span",{className:"font-medium",children:e.title}),": ",e.description]},t)),(null===(f=O.wealth_analysis.pattern_engine.top_patterns)||void 0===f?void 0:f.length)>0&&(0,l.jsx)("div",{className:"mt-2 text-xs px-2 py-1 rounded",style:{background:"color-mix(in srgb, var(--tui-earth) 25%, var(--tui-bg))",color:"var(--tui-earth)"},children:O.wealth_analysis.pattern_engine.top_patterns.slice(0,3).map((e,t)=>{var a;return(0,l.jsxs)("div",{children:[e.chinese_name,": ",null===(a=e.severity)||void 0===a?void 0:a.toFixed(0)," (",e.level,")"]},t)})}),!(null===(_=O.wealth_analysis.pattern_engine.recommendations)||void 0===_?void 0:_.length)&&O.wealth_analysis.analysis_text&&(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-earth)"},children:A(O.wealth_analysis,X)})]}),!(null==O?void 0:null===(j=O.wealth_analysis)||void 0===j?void 0:j.pattern_engine)&&(null==O?void 0:null===(N=O.wealth_analysis)||void 0===N?void 0:N.analysis_text)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-earth) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-earth) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-earth)"},children:K("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"favorable"===O.wealth_analysis.outlook?"var(--tui-wood)":"challenging"===O.wealth_analysis.outlook?"var(--tui-fire)":"var(--tui-metal)",color:"var(--tui-bg)"},children:er(O.wealth_analysis.outlook,"wealth")})]}),(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-earth)"},children:A(O.wealth_analysis,X)})]}),(null==O?void 0:null===(w=O.learning_analysis)||void 0===w?void 0:w.pattern_engine)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-water) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-water) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-water)"},children:Z("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"critical"===O.learning_analysis.pattern_engine.severity_level?"var(--tui-fire)":"major"===O.learning_analysis.pattern_engine.severity_level?"var(--tui-accent-orange)":"moderate"===O.learning_analysis.pattern_engine.severity_level?"var(--tui-earth)":"var(--tui-wood)",color:"var(--tui-bg)"},children:O.learning_analysis.pattern_engine.severity_level||"balanced"})]}),(null===(k=O.learning_analysis.pattern_engine.top_patterns)||void 0===k?void 0:k.length)>0&&(0,l.jsx)("div",{className:"mt-2 text-xs px-2 py-1 rounded",style:{background:"color-mix(in srgb, var(--tui-water) 25%, var(--tui-bg))",color:"var(--tui-water)"},children:O.learning_analysis.pattern_engine.top_patterns.slice(0,3).map((e,t)=>{var a;return(0,l.jsxs)("div",{children:[e.chinese_name,": ",null===(a=e.severity)||void 0===a?void 0:a.toFixed(0)," (",e.level,")"]},t)})}),O.learning_analysis.analysis_text&&(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-water)"},children:A(O.learning_analysis,X)})]}),!(null==O?void 0:null===(W=O.learning_analysis)||void 0===W?void 0:W.pattern_engine)&&(null==O?void 0:null===(D=O.learning_analysis)||void 0===D?void 0:D.analysis_text)&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-water) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-water) 40%, var(--tui-bg))"},children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("div",{className:"font-medium",style:{color:"var(--tui-water)"},children:Z("title")}),(0,l.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{background:"favorable"===O.learning_analysis.outlook?"var(--tui-wood)":"challenging"===O.learning_analysis.outlook?"var(--tui-fire)":"var(--tui-metal)",color:"var(--tui-bg)"},children:er(O.learning_analysis.outlook,"learning")})]}),(0,l.jsx)("div",{className:"mt-1",style:{color:"var(--tui-water)"},children:A(O.learning_analysis,X)})]}),(null==O?void 0:null===(S=O.special_stars)||void 0===S?void 0:S.length)>0&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-accent-purple) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-accent-purple) 40%, var(--tui-bg))"},children:[(0,l.jsx)("div",{className:"font-medium mb-1",style:{color:"var(--tui-accent-purple)"},children:"神煞 Special Stars"}),(0,l.jsx)("div",{className:"space-y-1",children:O.special_stars.map((e,t)=>(0,l.jsxs)("div",{className:"text-xs",style:{color:"var(--tui-accent-purple)"},children:[(0,l.jsx)("span",{className:"font-medium",children:e.chinese_name})," (",e.english_name,") - ",e.target_branch]},t))})]}),(null==O?void 0:null===(E=O.recommendations)||void 0===E?void 0:E.length)>0&&(0,l.jsxs)("div",{className:"px-3 py-2 text-sm",style:{background:"color-mix(in srgb, var(--tui-wood) 15%, var(--tui-bg))",border:"1px solid color-mix(in srgb, var(--tui-wood) 40%, var(--tui-bg))"},children:[(0,l.jsx)("div",{className:"font-medium mb-1",style:{color:"var(--tui-wood)"},children:"Recommendations"}),(0,l.jsx)("div",{className:"space-y-2",children:O.recommendations.map((e,t)=>{var a;return(0,l.jsxs)("div",{className:"text-xs p-2 rounded",style:{background:"high"===e.priority?"color-mix(in srgb, var(--tui-fire) 25%, var(--tui-bg))":"medium"===e.priority?"color-mix(in srgb, var(--tui-earth) 25%, var(--tui-bg))":"color-mix(in srgb, var(--tui-wood) 25%, var(--tui-bg))",color:"high"===e.priority?"var(--tui-fire)":"medium"===e.priority?"var(--tui-earth)":"var(--tui-wood)"},children:[(0,l.jsxs)("div",{className:"font-medium",children:["[",null===(a=e.priority)||void 0===a?void 0:a.toUpperCase(),"] ",e.title]}),(0,l.jsx)("div",{className:"mt-0.5",children:e.description})]},t)})})]}),(null==O?void 0:null===(L=O.ten_gods_detail)||void 0===L?void 0:null===(M=L.warnings)||void 0===M?void 0:M.length)>0&&(0,l.jsxs)("div",{className:"px-3 py-2 tui-bg-alt tui-frame text-sm",children:[(0,l.jsx)("div",{className:"font-medium tui-text mb-1",children:Q("warnings_title")}),(0,l.jsx)("div",{className:"space-y-1",children:O.ten_gods_detail.warnings.map((e,t)=>{var a;let i="zh"===X?e.ten_god_chinese||e.ten_god:e.ten_god_english||e.ten_god,s=(null===(a=({year:{en:"year",zh:"年",id:"tahun"},month:{en:"month",zh:"月",id:"bulan"},day:{en:"day",zh:"日",id:"hari"},hour:{en:"hour",zh:"時",id:"jam"}})[e.pillar])||void 0===a?void 0:a[X])||e.pillar,n="zh"===X?e.message_chinese:"id"===X&&e.message_id||e.message;return(0,l.jsxs)("div",{className:"tui-text-dim text-xs",children:[(0,l.jsx)("span",{className:"font-medium",children:i})," @ ",s,": ",n]},t)})})]})]})]}):(0,l.jsx)("div",{className:"py-8 text-center tui-text-muted",children:z("status.no_data")})}),!P&&!B&&!H&&(0,l.jsx)("div",{className:"border-t tui-border-color px-4 py-3",children:J?(0,l.jsxs)("div",{className:"relative",children:[(0,l.jsx)("textarea",{ref:es,value:V,onChange:e=>ee(e.target.value),onBlur:en,onKeyDown:e=>{"Escape"===e.key&&(ee(T.notes||""),$(!1)),(e.metaKey||e.ctrlKey)&&"Enter"===e.key&&en()},placeholder:"Add notes about this period...",className:"tui-input w-full text-sm px-3 py-2 resize-none min-h-[60px]",maxLength:1e4}),(0,l.jsxs)("div",{className:"flex justify-between items-center mt-1 text-xs tui-text-muted",children:[(0,l.jsx)("span",{children:"Press Escape to cancel, Cmd+Enter to save"}),et&&(0,l.jsx)("span",{children:z("actions.loading")})]})]}):(0,l.jsx)("div",{onClick:()=>$(!0),className:"text-sm cursor-pointer px-2 py-1 -mx-2 ".concat(V?"tui-text-dim":"tui-text-muted italic"),title:"Click to add notes",children:V||"Click to add notes..."})})]})}var Y=a(7776);function z(e){let{profileId:t,onSuccess:a,onCancel:i,existingDates:s=[],className:o=""}=e,d=new Date().getFullYear(),[c,u]=(0,n.useState)(d.toString()),[m,h]=(0,n.useState)(""),[v,x]=(0,n.useState)(""),[p,b]=(0,n.useState)(""),[y,g]=(0,n.useState)(""),[f,_]=(0,n.useState)(null),[j,N]=(0,n.useState)(!1),w=(0,n.useRef)(null),k=(0,n.useRef)(null),C=(0,n.useRef)(null),W=(0,n.useRef)(null);(0,n.useEffect)(()=>{var e;null===(e=w.current)||void 0===e||e.focus()},[]);let D="string"==typeof c?parseInt(c,10):c,S="string"==typeof m&&""!==m?parseInt(m,10):null,E="string"==typeof v&&""!==v?parseInt(v,10):null,M=!isNaN(D)&&D>=1900&&D<=2100,L=s.some(e=>e.year===D&&(e.month||null)===S&&(e.day||null)===E),F=(0,n.useCallback)(async()=>{if(_(null),!M){_("Please enter a valid year (1900-2100)");return}if(L){_("This date already exists in your life events");return}if(E&&!S){_("Please specify a month when adding a day");return}N(!0);try{let e={year:D,month:S,day:E,location:p.trim()||null,notes:y.trim()||null},l=await (0,r._j)(t,e);null==a||a(l)}catch(e){_(e instanceof Error?e.message:"Failed to create life event")}finally{N(!1)}},[M,L,D,S,E,p,y,t,a]),I=(0,n.useCallback)(e=>{let t=e.target.value;if(!/^\d*$/.test(t)||t.length>2)return;let a=parseInt(t,10);!(a>12)&&(h(t),(2===t.length||1===t.length&&a>1)&&setTimeout(()=>{var e;return null===(e=C.current)||void 0===e?void 0:e.focus()},0))},[]),T=(0,n.useCallback)(e=>{let t=e.target.value;/^\d*$/.test(t)&&!(t.length>2)&&(parseInt(t,10)>31||(x(t),2===t.length&&setTimeout(()=>{var e;return null===(e=W.current)||void 0===e?void 0:e.focus()},0)))},[]),O=(0,n.useCallback)(()=>{setTimeout(()=>{var e;return null===(e=k.current)||void 0===e?void 0:e.focus()},0)},[]),B=(0,n.useCallback)((e,t,a)=>{var l,i;"Backspace"===e.key&&(null===(l=t.current)||void 0===l?void 0:l.value)===""&&a&&(e.preventDefault(),null===(i=a.current)||void 0===i||i.focus())},[]);return(0,l.jsxs)(Y.RH,{title:"Add Life Event",onSubmit:F,onCancel:i,submitLabel:"Add",cancelLabel:"Cancel",isValid:M&&!L,error:f,className:o,children:[(0,l.jsxs)("div",{className:"chat-field",children:[(0,l.jsxs)("div",{className:"chat-field-label-row",children:[(0,l.jsxs)("span",{className:"chat-field-label",children:["Date:",(0,l.jsx)("span",{className:"chat-field-required",children:"*"})]}),(0,l.jsx)("span",{className:"chat-field-cursor chat-field-cursor-active",children:">"})]}),(0,l.jsx)("div",{className:"chat-field-input",children:(0,l.jsxs)("div",{className:"guided-date-input",children:[(0,l.jsx)("input",{ref:w,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:c,onChange:e=>{let t=e.target.value;if(/^\d*$/.test(t)&&!(t.length>4)&&(u(t),4===t.length)){let e=parseInt(t,10);e>=1900&&e<=2100&&O()}},placeholder:"YYYY",disabled:j,className:"guided-input-segment guided-input-year tui-input",style:M||""===c?{}:{borderColor:"var(--tui-error)"},"aria-label":"Year",autoComplete:"off"}),(0,l.jsx)("span",{className:"guided-input-separator",children:"/"}),(0,l.jsx)("input",{ref:k,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:m,onChange:I,onKeyDown:e=>B(e,k,w),placeholder:"MM",disabled:j,className:"guided-input-segment guided-input-month tui-input","aria-label":"Month (optional)",autoComplete:"off"}),(0,l.jsx)("span",{className:"guided-input-separator",children:"/"}),(0,l.jsx)("input",{ref:C,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:v,onChange:T,onKeyDown:e=>B(e,C,k),placeholder:"DD",disabled:j||!S,className:"guided-input-segment guided-input-day tui-input",style:S?{}:{opacity:.5},"aria-label":"Day (optional)",autoComplete:"off"})]})}),(0,l.jsx)("div",{className:"chat-field-hint",children:"Year required, month and day optional"})]}),(0,l.jsxs)("div",{className:"chat-field",children:[(0,l.jsxs)("div",{className:"chat-field-label-row",children:[(0,l.jsxs)("span",{className:"chat-field-label",children:["Location:",(0,l.jsx)("span",{className:"tui-text-muted",style:{fontSize:"0.625rem",marginLeft:"0.25rem"},children:"(optional)"})]}),(0,l.jsx)("span",{className:"chat-field-cursor",children:">"})]}),(0,l.jsx)("div",{className:"chat-field-input",children:(0,l.jsx)("input",{ref:W,type:"text",value:p,onChange:e=>b(e.target.value),placeholder:"Where did this happen?",className:"tui-input w-full",maxLength:200,disabled:j,autoComplete:"off"})})]}),(0,l.jsxs)("div",{className:"chat-field",children:[(0,l.jsxs)("div",{className:"chat-field-label-row",children:[(0,l.jsxs)("span",{className:"chat-field-label",children:["Notes:",(0,l.jsx)("span",{className:"tui-text-muted",style:{fontSize:"0.625rem",marginLeft:"0.25rem"},children:"(optional)"})]}),(0,l.jsx)("span",{className:"chat-field-cursor",children:">"})]}),(0,l.jsx)("div",{className:"chat-field-input",children:(0,l.jsx)("textarea",{value:y,onChange:e=>g(e.target.value),placeholder:"What happened during this period?",className:"tui-input w-full resize-none",rows:2,maxLength:1e4,disabled:j})})]}),L&&(0,l.jsx)("div",{className:"chat-form-error",role:"alert",children:"This date already exists in your life events"})]})}function G(e,t){return e.year!==t.year?e.year-t.year:(e.month||0)!==(t.month||0)?(e.month||0)-(t.month||0):(e.day||0)-(t.day||0)}function K(e){let{profileId:t}=e,a=(0,i.useRouter)(),[s,d]=(0,n.useState)(null),[c,u]=(0,n.useState)(null),[m,h]=(0,n.useState)([]),[v,x]=(0,n.useState)(!0),[p,b]=(0,n.useState)(null),[y,g]=(0,n.useState)(!1),f=(0,n.useCallback)(async(e,t)=>(0,r.H4)({birthDate:e.birth_date,birthTime:e.birth_time||"",gender:e.gender,unknownHour:!e.birth_time,analysisYear:t.year,includeAnnualLuck:!0,analysisMonth:t.month||null,includeMonthlyLuck:!!t.month,analysisDay:t.day||null,includeDailyLuck:!!t.day}),[]),_=(0,n.useCallback)(async()=>{try{x(!0),b(null);let e=await (0,r.Ai)(t);d(e);let a=await (0,r.H4)({birthDate:e.birth_date,birthTime:e.birth_time||"",gender:e.gender,unknownHour:!e.birth_time});u(a);let l=[...e.life_events||[]].sort(G),i=l.map(e=>({event:e,chartData:null,isLoading:!0,error:null}));h(i);for(let t=0;t<l.length;t++)try{let a=await f(e,l[t]);h(e=>e.map((e,l)=>l===t?{...e,chartData:a,isLoading:!1}:e))}catch(e){h(a=>a.map((a,l)=>l===t?{...a,isLoading:!1,error:e instanceof Error?e.message:"Failed to load"}:a))}}catch(e){b(e instanceof Error?e.message:"Failed to load profile")}finally{x(!1)}},[t,f]);(0,n.useEffect)(()=>{_()},[_]);let j=(0,n.useCallback)(e=>{d(e)},[]),N=(0,n.useCallback)(async e=>{if(g(!1),!s)return;let t={event:e,chartData:null,isLoading:!0,error:null};h(e=>[...e,t].sort((e,t)=>G(e.event,t.event))),d(t=>t?{...t,life_events:[...t.life_events||[],e]}:null);try{let t=await f(s,e);h(a=>a.map(a=>a.event.id===e.id?{...a,chartData:t,isLoading:!1}:a))}catch(t){h(a=>a.map(a=>a.event.id===e.id?{...a,isLoading:!1,error:t instanceof Error?t.message:"Failed to load"}:a))}},[s,f]),w=(0,n.useCallback)(e=>{h(t=>t.map(t=>t.event.id===e.id?{...t,event:e}:t)),d(t=>t?{...t,life_events:(t.life_events||[]).map(t=>t.id===e.id?e:t)}:null)},[]),k=(0,n.useCallback)(async e=>{try{await (0,r.SB)(t,e),h(t=>t.filter(t=>t.event.id!==e)),d(t=>t?{...t,life_events:(t.life_events||[]).filter(t=>t.id!==e)}:null)}catch(e){console.error("Failed to delete event:",e)}},[t]),C={id:"natal",year:s?parseInt(s.birth_date.split("-")[0]):0,month:s?parseInt(s.birth_date.split("-")[1]):null,day:s?parseInt(s.birth_date.split("-")[2]):null,notes:null,created_at:"",updated_at:""};if(v&&!s)return(0,l.jsxs)("div",{className:"py-12 text-center tui-text-muted",children:[(0,l.jsx)("div",{className:"inline-block animate-spin h-6 w-6 border-2 tui-border mr-2",style:{borderTopColor:"var(--tui-water)"}}),"Loading profile..."]});if(p)return(0,l.jsxs)("div",{className:"py-12 text-center",children:[(0,l.jsx)("div",{className:"mb-4",style:{color:"var(--tui-error)"},children:p}),(0,l.jsx)("button",{onClick:()=>a.push("/"),className:"tui-btn",children:"Back to Profiles"})]});if(!s)return(0,l.jsx)("div",{className:"py-12 text-center tui-text-muted",children:"Profile not found"});let W=m.map(e=>({year:e.event.year,month:e.event.month,day:e.event.day}));return(0,l.jsxs)("div",{className:"min-h-screen tui-bg",children:[(0,l.jsx)(o,{profile:s,onProfileUpdate:j,onBack:()=>a.push("/")}),(0,l.jsxs)("div",{className:"px-4 pb-8 space-y-4",children:[c&&(0,l.jsx)(q,{profileId:t,event:C,chartData:c,isNatal:!0}),m.map(e=>(0,l.jsx)(q,{profileId:t,event:e.event,chartData:e.chartData,isLoading:e.isLoading,error:e.error,onDelete:()=>k(e.event.id),onEventUpdate:w},e.event.id)),y?(0,l.jsx)("div",{className:"py-2",children:(0,l.jsx)(z,{profileId:t,onSuccess:N,onCancel:()=>g(!1),existingDates:W})}):(0,l.jsxs)("button",{onClick:()=>g(!0),className:"w-full py-3 border-2 border-dashed tui-border-color tui-text-muted transition-colors flex items-center justify-center gap-2",style:{"--hover-border":"var(--tui-water)"},children:[(0,l.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",viewBox:"0 0 20 20",fill:"currentColor",children:(0,l.jsx)("path",{fillRule:"evenodd",d:"M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z",clipRule:"evenodd"})}),"Add Life Event"]})]})]})}function Z(){let e=(0,i.useParams)(),t=null==e?void 0:e.id;return t&&"_"!==t?(0,l.jsxs)("div",{className:"min-h-screen tui-bg",children:[(0,l.jsx)(s.Z,{}),(0,l.jsx)("main",{className:"mx-auto main-content",children:(0,l.jsx)("div",{className:"mx-auto",style:{maxWidth:"900px"},children:(0,l.jsx)(K,{profileId:t})})})]}):(0,l.jsxs)("div",{className:"min-h-screen tui-bg",children:[(0,l.jsx)(s.Z,{}),(0,l.jsx)("main",{className:"mx-auto main-content p-4",children:(0,l.jsx)("p",{className:"text-center tui-text-muted",children:"Loading..."})})]})}}},function(e){e.O(0,[397,805,159,971,117,744],function(){return e(e.s=6832)}),_N_E=e.O()}]);